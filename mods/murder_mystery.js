/* Editable fields */
var energy_delay = 3; // Delay between each item spawns (in seconds)
var items_required = 3; // Item needs to be collected to earn one shot
var detective_reload_time = 10; // Delay between each detective's shots
var player_laser_speed = 300; // Speed of each player's shots (execpt murderers)
var murderer_reload_time = 5; // Delay between each murderer's shots
var regen_factor = 0; // regen factor of the players (inlcuding murderers)
/* End of editable fields */

/*
The rest are game mechanics.
DO NOT fix anything below this line unless you know what you're doing
*/
var capacity = 200*items_required;
var shield = capacity-100;
var specs = JSON.stringify({
  specs: {
    shield: {
      capacity: [shield,shield],
      reload: [1,1]
    },
    generator: {
      capacity: [capacity,capacity]
    },
    ship: {
      mass: 675,
      speed: [155,155],
      rotation: [130,130],
      acceleration: [120,120]
    }
  }
}), dash = {
  dash: {
    rate: 1,
    burst_speed: [200,200],
    speed: [150,150],
    acceleration: [70,70],
    initial_energy: [100,100],
    energy: [20,20]
  }
}, laser = JSON.stringify({
  damage: [capacity,capacity],
  speed: [player_laser_speed, player_laser_speed],
  rate: 1,
  type: 2,
  recoil: 0,
  number: 1,
  error: 0
})
var mod = function(ship, handler) {
  typeof handler == "function" && [[],["typespec"]].forEach(i => {
    let param = ship;
    i.forEach(j => (param = param[j]));
    handler(param);
  });
}

var Template = '{"size":2.4,"bodies":{"body":{"section_segments":12,"offset":{"x":0,"y":0,"z":0},"position":{"x":[0,0,0,0,0,0,0,0,0,0],"y":[-90,-100,-60,-10,0,20,50,80,100,90],"z":[0,0,0,0,0,0,0,0,0,0,0]},"width":[0,5,20,25,35,40,40,35,30,0],"height":[0,5,40,45,40,60,70,60,30,0],"texture":[10,2,10,2,3,13,13,63,12],"propeller":true,"laser":{}},"front":{"section_segments":8,"offset":{"x":0,"y":-20,"z":0},"position":{"x":[0,0,0,0,0],"y":[-90,-85,-70,-60,-20],"z":[0,0,0,0,0]},"width":[0,40,45,10,12],"height":[0,15,18,8,12],"texture":[8,63,4,4,4],"propeller":true},"propeller":{"section_segments":10,"offset":{"x":40,"y":40,"z":0},"position":{"x":[0,0,0,0,0,0,0,0,0,0],"y":[-20,-15,0,10,20,25,30,40,70,60],"z":[0,0,0,0,0,0,0,0,0,0]},"width":[0,10,15,15,15,10,10,20,15,0],"height":[0,10,15,15,15,10,10,18,8,0],"texture":[4,4,10,3,3,63,4,63,12],"propeller":true},"sides":{"section_segments":6,"angle":90,"offset":{"x":0,"y":0,"z":0},"position":{"x":[0,0,0,0,0,0,0,0,0,0],"y":[-80,-75,-60,-50,-10,10,50,60,75,80],"z":[0,0,0,0,0,0,0,0,0,0]},"width":[0,30,35,10,12,12,10,35,30,0],"height":[0,10,12,8,12,12,8,12,10,0],"texture":[4,63,4,4,4,4,4,63,4]},"cockpit":{"section_segments":12,"offset":{"x":0,"y":-20,"z":30},"position":{"x":[0,0,0,0,0,0,0,0],"y":[-50,-20,0,10,30,50],"z":[0,0,0,0,0,0]},"width":[0,12,18,20,15,0],"height":[0,20,22,24,20,0],"texture":[9]}},"wings":{"top":{"doubleside":true,"offset":{"x":0,"y":20,"z":15},"length":[70],"width":[70,30],"angle":[90],"position":[0,30],"texture":[63],"bump":{"position":10,"size":30}},"top2":{"doubleside":true,"offset":{"x":0,"y":51,"z":5},"length":[70],"width":[50,20],"angle":[90],"position":[0,60],"texture":[63],"bump":{"position":10,"size":30}}},"typespec":{"code":null,"shape":[5.28,5.25,5.332,5.393,4.944,1.997,1.745,1.556,1.435,3.587,3.81,3.779,3.838,3.84,3.779,3.81,3.587,3.205,3.571,3.9,5.132,5.888,5.835,5.551,4.886,5.808,4.886,5.551,5.835,5.888,5.132,3.9,3.571,3.205,3.587,3.81,3.779,3.838,3.84,3.779,3.81,3.587,1.435,1.556,1.745,1.997,4.944,5.393,5.332,5.25],"lasers":[{"x":0,"y":-4.8,"z":0,"angle":0,"spread":0,"error":0,"recoil":0}],"radius":5.888}}';
var names = ["Player", "Detective", "Murderer"];

var ships = Array(3).fill(0).map((v,i) => {
  let pship = JSON.parse(Template);
  mod(pship, function(ship){
    ship.name = names[i];
    ship.level = 1;
    ship.model = i+1;
    Object.assign(ship,JSON.parse(specs));
  });
  pship.typespec.code = pship.level * 100 + pship.model;
  pship.bodies.body.laser = JSON.parse(laser);
  Object.assign(pship.typespec.lasers[0], JSON.parse(laser));
  return pship
});

mod(ships[0], function(ship){
  ship.specs.generator.reload = [1e-30,1e-30]
});

mod(ships[1], function(ship){
  let t = capacity/detective_reload_time;
  ship.specs.generator.reload = [t,t];
});

mod(ships[2], function(ship){
  let t = capacity/murderer_reload_time, g = capacity+100;
  ship.specs.generator = {
    capacity: [g,g],
    reload: [t,t]
  }
  Object.assign(ship.specs.ship,dash);
});
let h = [1e-30, 1e-30];
ships[2].bodies.body.laser.speed = h;
ships[2].typespec.lasers[0].speed = h;

ships = ships.map(ship=>JSON.stringify(ship));
var map = "99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999                          9                                                                                                                                                                   99999\n"+
"9999                           9                                                                                                                                                                    9999\n"+
"999                            9                                                                                                                                                                     999\n"+
"999                            9                                                                                                                                                                     999\n"+
"999                            9                                                                                                                                                                     999\n"+
"999     9                      9                                                                                                                                                                     999\n"+
"999     99           999999999999999999999         9                     9          5555555555555555555555555                                                                                        999\n"+
"999     959           95555555555555555559         99                   99          5555555555555555555555555                                                                                        999\n"+
"999     9559           9599999955555999959         9 9                 9 9          5555555559999999555555555                                                                                        999\n"+
"999     95959           959999999599999959         9  9               9  9          5555555999999999995555555                                                                                        999\n"+
"999     959959           95999999559999959         9   9             9   9          5555559999999999999555555                                                                                        999\n"+
"999     9599959           9599999595999959         9    9           9    9          5555599199999999999955555                                                                                        999\n"+
"999     95999959           959999599599959         9    99         9     9          5555991191999111111995555                                                                                        999\n"+
"999     959999959           95999599959959         9    999       9      9          5559911911111111111999555                                                                                        999\n"+
"999     9599999959           9599999995959         9    9999     9       9          5559919111111111111999555                                                                                        999\n"+
"999     95955599959           959999999559         9    99999   9        9          5599991111111199111999955                                                                                        999\n"+
"999     95599959959            95555555559         9    999999 9         9          5599999111111999111999955        9                                                                               999\n"+
"999     95599999959             9999999999         9    9999999          9          5599999911119991111999955         9                                                                              999\n"+
"999     95599999959                                9                     9          5599999991119911119999955          9                                                                             999\n"+
"999     95955599959                                9                     9          5599999919111111119999955           9                                                                            999\n"+
"999     95999959559                                9                     9          5599999911911111119999955            9                                                                           999\n"+
"999     95999959559     9                          9                     9          5599999191191111111999955             9                                                                          999\n"+
"999     95599959555     99                         9                     9          5559991119119111119999555              9                                                                         999\n"+
"999     95955599555     999                        9                     9          5559991111999911181199555               9                                                                        999\n"+
"999     95999999555     999                        9                     9          5555911119999991811995555                9                                                                       999\n"+
"999     95999999555     999                        9                     9          5555511999999999119955555               9                                                                        999\n"+
"999     95999999555      99      999999999999999999999999999999          9          5555119999999999999555555              9                                                                         999\n"+
"999     95999999555       9      9                            9          9          5555555999999999995555555             9                                                                          999\n"+
"999     95999999555       9      9                            9          9          5555555559999999555555555            9                                                                           999\n"+
"999     95999999555       9      9                            9          9          5555555555555555555555555           9                                                                            999\n"+
"999     95999999555       9      9                            9          9          5555555555555555555555555          9                                                                             999\n"+
"999     95999999555       9      9                                        9                                           9                                                                              999\n"+
"999     95999999555       9      999999999999     9                        9                                         9                                                                               999\n"+
"999     95999999555       9      9    9           9                         9                                       9                                                                                999\n"+
"999     95999999555       9      9    9           9                          9                                     9                                                                                 999\n"+
"999     959999 9555       9      9    9           9                           9                                   9                                                                                  999\n"+
"999     95999   955       9      9    9           9                            9                                 9                                                                                   999\n"+
"999     9599     95       9      9    9           9                             9                               9                                                                                    999\n"+
"999     959       9       9      9    9           9                              9                             9                                                                                     999\n"+
"999     99         9      9      9    9           9                               9                           9                                                                                      999\n"+
"999     9           9     9      9    9999999     999999      9                    9                         9                                                                                       999\n"+
"999    9             9    9      9                9           9                     9999999999999999999999999                                                                                        999\n"+
"999   9               9   9      9                9           9                                                                                                                                      999\n"+
"999  9                 9  9      9                9           9                                                                                                                                      999\n"+
"999 9                   9 9      9                9           9                                                                                                                                      999\n"+
"9999                     99      9                9           9                                                                                                                                      999\n"+
"999                       9999999999999999999999999           9                                                                                                                                      999\n"+
"999                                                           9                                                                                                                                      999\n"+
"999                                                           9                                                                                                                                      999\n"+
"999                                                           9                                                                                                                                      999\n"+
"999           9                                               9                                                                                                                                      999\n"+
"999          959                                              9                                                                                                                                      999\n"+
"999         95959                                             9                                                                                                                                      999\n"+
"999        9599959                                            9                                                                                                                                      999\n"+
"999       95999995999999999999999999999999999999999999999999999                                                                                                                                      999\n"+
"999      95999999955555555555555559         9                9                                                                                                                                       999\n"+
"999     95999999599599999999999959         9                9                                                                                                                                        999\n"+
"999     9599999959995999999999959         9                9                                                                                                                                         999\n"+
"999     959999955599599999999959         9                9                                                                                                                                          999\n"+
"999     95999995959959999999959         9                9                                                                                                                                           999\n"+
"999     9599995595595999999959         9                9                                                                                                                                            999\n"+
"999     959999599959599999959         9                9                                                                                                                                             999\n"+
"999     95999555555559999959         9                9           9999999999999999                                    9999999999999999                                                               999\n"+
"999     9599959599955999959         9                 9           9999999                                                      9999999                                                               999\n"+
"999     959955995995599959         9                  9           99999                                                          99999                                                               999\n"+
"999     95955999959959959         9                   9           9999                                                            9999                                                               999\n"+
"999     9559599999595959         9                    9           999                                                              999                                                               999\n"+
"999     959999999995559         9                     9           99                                                                99                                                               999\n"+
"999      9599999999959         9                      9           99                                                                99                                                               999\n"+
"999       95999999959         9                       9           9                                                                  9                                                               999\n"+
"999        959999959          9                       9           9                                                                  9                                                               999\n"+
"999         9599959            9                      9           9                                                                  9                                                               999\n"+
"999          95959              9                     9           9                                                                  9                                                               999\n"+
"999           959                9                    9           9                                                                  9                                                               999\n"+
"999            9                  9                   9           9                                99                                9                                                               999\n"+
"999                     9          9                  9           9                               9999                               9                                                               999\n"+
"999                    959          9                 9           9                              919919                              9                                                               999\n"+
"999                   95559          9                9           9                             91199119                             9                                                               999\n"+
"999                  9595959          9               9           9               999999999999991119911199999999999999               9                                                               999\n"+
"999                 959959959         9               9                           991111191111911119911119111191111199                                                                               999\n"+
"999                95999599959        9               9                           919111191119111119911111911191111919                                                                               999\n"+
"999               9599995999959       9               9                           911911191191111119911111191191119119                                                                               999\n"+
"999              959999959999959      9               9                           911199991911111119911111119199991119                                                                               999\n"+
"999             95999999599999959     9               9                           911199119999999999999999999911991119                                                                               999\n"+
"999            959999999599999959     9               9                           911191911911111199991111119119191119                                                                               999\n"+
"999           9599999999599999959     9               9                           999991191191111919919111191191199999                                                                               999\n"+
"999          95999999999599999959     9               9                           911119119119119119911911911911911119                                                                               999\n"+
"999         959999999999599999959     9               9                           911199911911991119911199119119991119                                                                               999\n"+
"999        9599999999999599999959     9               9                           911919191191191119911191191191919119                                                                               999\n"+
"999       95999999999999599999959     9               9                           919119119119119119911911911911911919                                                                               999\n"+
"999      959999999999999599999959     9               9                           991119111911911919919119119111911199                                                                               999\n"+
"999     9599999955599999599999959     9               9                           911119111991191999991191199111911119                                                                               999\n"+
"999     9599999959959999599999959     9               9                          91111191191191199999999119119119111119                                                                              999\n"+
"999     9599999959995999599999959     9               9                         9111111919111191999999991911119191111119                                                                             999\n"+
"999     9599999959995995955999959     99999999999999999                        911111119911111199999999991111119911111119                                                                            999\n"+
"999     9599999959995959999595559                                             99999999999999999999999999999999999999999999                                                                           999\n"+
"999     9599999959959599999955959                                             99999999999999999999999999999999999999999999                                                                           999\n"+
"999     959999995959599999999959                                               911111119911111199999999991111119911111119                                                                            999\n"+
"999     95999999559599999999959                                                 9111111919111191999999991911119191111119                                                                             999\n"+
"999     9599999959599999999959                                                   91111191191191199999999119119119111119                                                                              999\n"+
"999     959999995595999999959                                                     911119111991191199991191199111911119                                                                               999\n"+
"999     95999999599959999959                                                      991119111911911919919119119111911199                                                                               999\n"+
"999     9599999559999599959                                                       919119119119119119911911911911911919                                                                               999\n"+
"999     959999595999995959                                                        911919191191191119911191191191919119                                                                               999\n"+
"999     95999599999999959                                                         911199911911991119911199119119991119                                                                               999\n"+
"999     9599599999999959                                                          911119119119119119911911911911911119                                                                               999\n"+
"999     959599999999959                                                           999991191191111919919111191191199999                                                                               999\n"+
"999     95599999999959                                                            911191911911111199991111119119191119                                                                               999\n"+
"999     9555555555559                                                             911199119999999999999999999911991119                                                                               999\n"+
"999     999999999999                                                              911199991911111119911111119199991119                                                                               999\n"+
"999                                                                               911911191191111119911111191191119119                                                                               999\n"+
"999                                                                               919111191119111119911111911191111919                                                                               999\n"+
"999                                                                               991111191111911119911119111191111199                                                                               999\n"+
"999                                                               9               999999999999991119911199999999999999               9                                                               999\n"+
"999                                                               9                             91199119                             9                                                               999\n"+
"999                                                               9                              919919                              9                                                               999\n"+
"999                                                               9                               9999                               9                                                               999\n"+
"999                                                               9                                99                                9                                                               999\n"+
"999                                                               9                                                                  9                                                               999\n"+
"999                                                               9                                                                  9                                                               999\n"+
"999                                                               9                                                                  9                                                               999\n"+
"999                                                               9                                                                  9                                                               999\n"+
"999                                                               9                                                                  9                                                               999\n"+
"999                                                               99                                                                99                                                               999\n"+
"999                                                               99                                                                99                                                               999\n"+
"999                                                               999                                                              999                                                               999\n"+
"999                                                               9999                                                            9999                                                               999\n"+
"999                                                               99999                                                          99999                                                               999\n"+
"999                                                               9999999                                                      9999999                                                               999\n"+
"999                                                               9999999999999999                                    9999999999999999                                                               999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"999                                                                                                                                                                                                  999\n"+
"9999                                                                                                                                                                                                9999\n"+
"99999                                                                                                                                                                                              99999\n"+
"999999                                                                                                                                                                                            999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\n"+
"99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999";
this.options = {
  // see documentation for options reference
  root_mode: "",
  name: "Starblast Murder Mystery",
  ships: ships,
  reset_tree: true,
  max_players: 30,
  map_size: 200,
  asteroids_strength: 1e6,
  crystal_value: 0,
  auto_refill: true,
  shield_regen_factor: regen_factor,
  lives: 0,
  custom_map: map
};
var coords = [], bmap = map.split("\n");
var rand = function(num) {
  return Math.floor(Math.random()*num)
}
for (let i = 0; i<bmap.length ; i++)
  for (let j = 0; j<bmap[i].length;j++) {
    let t = Number(bmap[i][j]);
    (!t || isNaN(t)) && coords.push([i,j])
  }
randomSpawn = function () {
  let [x,y] = coords[rand(coords.length)];
  return {x: (x*2-game.options.map_size+1)*5,y: (game.options.map_size-y*2-1)*5}
}

this.tick = function(game) {
  if (game.step % (energy_delay*60) === 0) {
    let f = randomSpawn();
    f.code = 90;
    game.addCollectible(f);
  }
}
